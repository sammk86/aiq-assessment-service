// Prisma Schema for Assessment Service
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["assessment"]
}

model Assessment {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  frameworkId    String  @map("framework_id")
  name          String
  status        String   @default("draft") // draft, in_progress, completed, archived
  startDate     DateTime @map("start_date")
  endDate       DateTime? @map("end_date")
  targetEndDate DateTime? @map("target_end_date")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  stakeholders AssessmentStakeholder[]
  responses    Response[]
  evidenceLinks EvidenceLink[]
  recommendations Recommendation[]

  @@map("assessments")
  @@index([organizationId])
  @@index([status])
  @@index([frameworkId])
  @@schema("assessment")
}

model Question {
  id           String   @id @default(uuid())
  frameworkId  String   @map("framework_id")
  text         String   @db.Text
  responseType String   @map("response_type")
  dimension    String
  subDimension String?  @map("sub_dimension")
  scoringWeight Decimal? @default(1.0) @map("scoring_weight") @db.Decimal(3, 2)
  helpText     String?  @map("help_text") @db.Text
  options      Json?
  orderIndex   Int?     @map("order_index")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  responses    Response[]

  @@map("questions")
  @@index([frameworkId])
  @@index([dimension])
  @@schema("assessment")
}

model Response {
  id             String   @id @default(uuid())
  assessmentId   String   @map("assessment_id")
  questionId     String   @map("question_id")
  userId         String   @map("user_id")
  answer         Json
  justification  String?  @db.Text
  confidenceLevel Decimal? @default(0.5) @map("confidence_level") @db.Decimal(3, 2)
  submittedAt    DateTime @default(now()) @map("submitted_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question   Question   @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId, userId])
  @@map("responses")
  @@index([assessmentId])
  @@index([questionId])
  @@index([userId])
  @@schema("assessment")
}

model AssessmentStakeholder {
  id              String   @id @default(uuid())
  assessmentId    String   @map("assessment_id")
  userId          String   @map("user_id")
  role            String   @default("contributor")
  sections        String[]  // Array of dimension names
  completionStatus String   @default("not_started") @map("completion_status")
  assignedAt      DateTime @default(now()) @map("assigned_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, userId])
  @@map("assessment_stakeholders")
  @@index([assessmentId])
  @@index([userId])
  @@schema("assessment")
}

model EvidenceLink {
  id           String   @id @default(uuid())
  assessmentId String   @map("assessment_id")
  questionId    String   @map("question_id")
  evidenceId   String   @map("evidence_id")
  createdAt    DateTime @default(now()) @map("created_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, questionId, evidenceId])
  @@map("evidence_links")
  @@index([assessmentId])
  @@index([questionId])
  @@index([evidenceId])
  @@schema("assessment")
}

model Recommendation {
  id            String      @id @default(uuid())
  assessmentId  String      @map("assessment_id")
  dimension     String
  title         String
  description   String      @db.Text
  priority      String
  effort        String
  impactScore   Float?      @map("impact_score")
  status        String      @default("pending")
  rationale     String?     @db.Text
  questionRefs  Json?       @map("question_refs")
  traceId       String?     @map("trace_id")
  modelName     String?     @map("model_name")
  severity      String?
  rawPayload    Json?       @map("raw_payload")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("recommendations")
  @@index([assessmentId])
  @@index([traceId])
  @@schema("assessment")
}

model PromptTemplate {
  id           String   @id @default(uuid())
  name         String
  locale       String   @default("en-US")
  templateBody String   @map("template_body")
  version      Int
  isActive     Boolean  @default(true) @map("is_active")
  createdBy    String?  @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  providerConfigs LlmProviderConfig[]

  @@unique([name, locale, version])
  @@map("prompt_templates")
  @@index([locale])
  @@schema("assessment")
}

model LlmProviderConfig {
  id               String   @id @default(uuid())
  organizationId   String   @map("organization_id")
  provider         String
  model            String
  parameters       Json     @default("{}")
  vaultSecretPath  String   @map("vault_secret_path")
  promptTemplateId String?  @map("prompt_template_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  promptTemplate PromptTemplate? @relation(fields: [promptTemplateId], references: [id])

  @@unique([organizationId, provider], name: "organizationId_provider")
  @@map("llm_provider_configs")
  @@index([organizationId])
  @@index([provider])
  @@schema("assessment")
}

